# Sync submodule pointers on branch "local" to the tip of each submodule's "local" branch.
#
# Update logic mirrors add_submodule.update_translations_submodule(): set submodule URL
# and submodule's origin to authed URL, then "git submodule update --init" and
# "git submodule update --remote" so fetch can authenticate; commit and push.
#
# Workflow lives on master (default). Trigger: repository_dispatch (event_type
# "sync-local-pointer") or schedule (every 30 minutes).
#
# Manual trigger: POST /repos/{owner}/{repo}/dispatches
#   Body: {"event_type": "sync-local-pointer"}
#
# Required secret: SYNC_TOKEN â€” PAT with repo push permission for ORG/TRANSLATIONS_REPO.

name: Sync local pointer

on:
  repository_dispatch:
    types: [sync-local-pointer]
  schedule:
    - cron: "*/30 * * * *"

env:
  ORG: CppDigest
  TRANSLATIONS_REPO: boost-documentation-translations
  LOCAL_BRANCH: local

jobs:
  sync-local-pointer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SYNC_TOKEN }}
          ref: ${{ env.LOCAL_BRANCH }}
          submodules: "true"

      - name: Update submodule pointers to LOCAL_BRANCH tip
        env:
          BRANCH: ${{ env.LOCAL_BRANCH }}
          SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          set -e
          branch="$BRANCH"
          # Same pattern as add_submodule.update_translations_submodule(): authed URL for
          # submodule config and submodule's origin, then update --init and update --remote.
          authed_url() {
            case "$1" in
              https://github.com/*) echo "https://x-access-token:${SYNC_TOKEN}@github.com/${1#https://github.com/}" ;;
              *) echo "$1" ;;
            esac
          }
          while IFS= read -r path; do
            [ -z "$path" ] && continue
            url=$(git config -f .gitmodules --get "submodule.${path}.url" 2>/dev/null) || continue
            [ -z "$url" ] && continue
            suburl=$(authed_url "$url")
            git config "submodule.${path}.url" "$suburl"
            git submodule update --init "$path" || true
            [ ! -d "$path/.git" ] && continue
            git -C "$path" remote set-url origin "$suburl"
            git config "submodule.${path}.branch" "$branch"
            if ! git submodule update --remote "$path"; then
              echo "Skipping $path: update --remote failed (e.g. no branch $branch)"
              continue
            fi
            git add "$path"
            echo "Updated $path -> $(git -C "$path" rev-parse --short HEAD)"
          done < <(git config -f .gitmodules --get-regexp 'submodule\..*\.path' | sed 's/^[^ ]* //')
          if ! git diff --staged --quiet; then
            git -c user.name="Boost-Translation-CI-Bot" -c user.email="Boost-Translation-CI-Bot@cppdigest.local" \
              commit -m "Update libs submodules (local branch)"
            git push origin "HEAD:$branch"
            echo "Pushed to origin/$branch"
          else
            echo "No pointer changes. (If you see 'Skipping' above, push branch $branch in those submodule repos.)"
          fi
