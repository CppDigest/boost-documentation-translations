# Sync submodule pointers on branch "local" to the tip of each submodule's "local" branch.
#
# Same logic as add_submodule.finalize_translations_repo (lines 679-692): checkout
# super-repo's local branch; for each submodule, update to that submodule's local
# branch tip (submodule.<path>.branch + update --remote, then git add); commit and
# push with --force. Checkout (with token) persists credentials for submodules.
#
# Workflow lives on master (default). Trigger: repository_dispatch (event_type
# "sync-local-pointer") or schedule (every day).
#
# Manual trigger: POST /repos/{owner}/{repo}/dispatches
#   Body: {"event_type": "sync-local-pointer"}
#
# Required secret: SYNC_TOKEN â€” PAT with repo push permission for ORG/TRANSLATIONS_REPO.

name: Sync local pointer

on:
  repository_dispatch:
    types: [sync-local-pointer]
  schedule:
    - cron: "0 0 * * *"

env:
  ORG: CppDigest
  TRANSLATIONS_REPO: boost-documentation-translations
  LOCAL_BRANCH: local

jobs:
  sync-local-pointer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SYNC_TOKEN }}
          ref: ${{ env.LOCAL_BRANCH }}
          submodules: "true"

      - name: Update submodule pointers to LOCAL_BRANCH tip
        env:
          BRANCH: ${{ env.LOCAL_BRANCH }}
        run: |
          set -e
          branch="$BRANCH"
          # Same as add_submodule (679-692): for each submodule, set branch and update --remote, then add.
          while IFS= read -r path; do
            [ -z "$path" ] && continue
            [ ! -d "$path" ] && continue
            git config "submodule.${path}.branch" "$branch"
            git -C "$path" fetch origin "refs/heads/${branch}:refs/remotes/origin/${branch}" || true
            if ! git submodule update --remote "$path"; then
              echo "Skipping $path: update --remote failed (e.g. no branch $branch)"
              continue
            fi
            git add "$path"
            echo "Updated $path -> $(git -C "$path" rev-parse --short HEAD)"
          done < <(git config -f .gitmodules --get-regexp 'submodule\..*\.path' | sed 's/^[^ ]* //')
          if ! git diff --staged --quiet; then
            git -c user.name="Boost-Translation-CI-Bot" -c user.email="Boost-Translation-CI-Bot@cppdigest.local" \
              commit -m "Update libs submodules (local branch)"
            git push --force origin "HEAD:$branch"
            echo "Pushed to origin/$branch"
          else
            echo "No pointer changes. (If you see 'Skipping' above, push branch $branch in those submodule repos.)"
          fi
