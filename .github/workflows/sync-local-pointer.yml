# Sync submodule pointers on branch "local" to the tip of each submodule's "local" branch.
#
# Workflow lives on master (default). Trigger: repository_dispatch (event_type
# "sync-local-pointer") or schedule (every 30 minutes). On trigger, checks out
# branch "local", reads .gitmodules, and updates each submodule pointer to the
# latest commit of that submodule's "local" branch, then pushes to "local".
#
# Manual trigger: POST /repos/{owner}/{repo}/dispatches
#   Body: {"event_type": "sync-local-pointer"}
#
# Required secret: SYNC_TOKEN â€” PAT with repo push permission for ORG/TRANSLATIONS_REPO.

name: Sync local pointer

on:
  repository_dispatch:
    types: [sync-local-pointer]
  schedule:
    - cron: "*/30 * * * *"

env:
  ORG: CppDigest
  TRANSLATIONS_REPO: boost-documentation-translations
  LOCAL_BRANCH: local

jobs:
  sync-local-pointer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SYNC_TOKEN }}
          ref: ${{ env.LOCAL_BRANCH }}
          submodules: "true"

      - name: Update submodule pointers to LOCAL_BRANCH tip
        env:
          BRANCH: ${{ env.LOCAL_BRANCH }}
          SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          set -e
          branch="$BRANCH"
          # Ensure submodule fetch can authenticate (token may not persist from checkout)
          auth_url() {
            url=$(git -C "$1" config remote.origin.url 2>/dev/null) || return 1
            case "$url" in
              https://github.com/*) echo "https://x-access-token:${SYNC_TOKEN}@github.com/${url#https://github.com/}" ;;
              *) echo "$url" ;;
            esac
          }
          # Read .gitmodules and get all submodule paths
          # For each submodule: get latest commit of its LOCAL_BRANCH, update super-repo pointer
          while IFS= read -r path; do
            [ -z "$path" ] && continue
            [ ! -d "$path/.git" ] && continue
            suburl=$(auth_url "$path") && git -C "$path" remote set-url origin "$suburl"
            (cd "$path" && git fetch origin "$branch") || true
            rev=$(git -C "$path" rev-parse "origin/$branch" 2>/dev/null) || {
              echo "Skipping $path: origin/$branch not found (fetch may have failed)"
              continue
            }
            git -C "$path" checkout -q "$rev"
            git add "$path"
            echo "Updated $path -> ${rev:0:7}"
          done < <(git config -f .gitmodules --get-regexp 'submodule\..*\.path' | sed 's/^[^ ]* //')
          if ! git diff --staged --quiet; then
            git -c user.name="Boost-Translation-CI-Bot" -c user.email="Boost-Translation-CI-Bot@cppdigest.local" \
              commit -m "Update libs submodules (local branch)"
            git push origin "HEAD:$branch"
            echo "Pushed to origin/$branch"
          else
            echo "No pointer changes. (If you see 'Skipping' above, push branch $branch in those submodule repos.)"
          fi
